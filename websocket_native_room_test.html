<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Native WebSocket Room Chat Test</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        display: grid;
        grid-template-columns: 300px 1fr;
        height: calc(100vh - 40px);
      }

      .sidebar {
        background: #2c3e50;
        color: white;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }

      .sidebar h2 {
        margin-bottom: 20px;
        font-size: 20px;
        border-bottom: 2px solid #34495e;
        padding-bottom: 10px;
      }

      .user-info {
        background: #34495e;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .user-info input {
        width: 100%;
        padding: 8px;
        border: none;
        border-radius: 4px;
        margin-top: 5px;
      }

      .status {
        padding: 8px;
        border-radius: 4px;
        margin: 10px 0;
        text-align: center;
        font-weight: bold;
      }

      .status.connected {
        background: #27ae60;
      }

      .status.disconnected {
        background: #e74c3c;
      }

      .rooms-section {
        flex: 1;
        overflow-y: auto;
      }

      .rooms-section h3 {
        font-size: 16px;
        margin: 20px 0 10px 0;
        color: #ecf0f1;
      }

      .room-list {
        list-style: none;
      }

      .room-item {
        background: #34495e;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .room-item:hover {
        background: #415771;
      }

      .room-item.active {
        background: #667eea;
      }

      .room-item .room-name {
        font-weight: bold;
      }

      .room-item .user-count {
        font-size: 12px;
        color: #bdc3c7;
      }

      .new-room {
        margin-top: 10px;
      }

      .new-room input {
        width: calc(100% - 60px);
        padding: 8px;
        border: none;
        border-radius: 4px;
      }

      .new-room button {
        width: 50px;
        padding: 8px;
        margin-left: 5px;
        background: #667eea;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
      }

      .chat-area {
        display: flex;
        flex-direction: column;
        background: #ecf0f1;
      }

      .chat-header {
        background: white;
        padding: 20px;
        border-bottom: 1px solid #ddd;
      }

      .chat-header h1 {
        color: #2c3e50;
        font-size: 24px;
      }

      .chat-header .room-info {
        color: #7f8c8d;
        font-size: 14px;
        margin-top: 5px;
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }

      .message {
        margin: 10px 0;
        padding: 12px 15px;
        border-radius: 8px;
        max-width: 70%;
        word-wrap: break-word;
      }

      .message.own {
        background: #667eea;
        color: white;
        margin-left: auto;
        text-align: right;
      }

      .message.other {
        background: white;
        color: #2c3e50;
        margin-right: auto;
      }

      .message.system {
        background: #f39c12;
        color: white;
        margin: 10px auto;
        text-align: center;
        max-width: 50%;
      }

      .message .username {
        font-weight: bold;
        font-size: 12px;
        margin-bottom: 4px;
      }

      .message .text {
        margin: 5px 0;
      }

      .message .timestamp {
        font-size: 10px;
        opacity: 0.7;
        margin-top: 4px;
      }

      .input-area {
        background: white;
        padding: 20px;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 10px;
      }

      .input-area input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 25px;
        font-size: 14px;
      }

      .input-area button {
        padding: 12px 30px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
      }

      .input-area button:hover {
        background: #5568d3;
      }

      .input-area button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }

      button {
        cursor: pointer;
        transition: opacity 0.3s;
      }

      button:hover:not(:disabled) {
        opacity: 0.9;
      }

      .no-room-selected {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #7f8c8d;
        font-size: 18px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar">
        <h2>ðŸš€ Native WebSocket Chat</h2>

        <div class="user-info">
          <label>Your Username:</label>
          <input type="text" id="usernameInput" placeholder="Enter username..." />
          <button
            id="setUsernameBtn"
            style="
              margin-top: 10px;
              width: 100%;
              padding: 8px;
              background: #667eea;
              border: none;
              border-radius: 4px;
              color: white;
            "
          >
            Set Username
          </button>
        </div>

        <div class="status disconnected" id="status">Disconnected</div>
        <button
          id="connectBtn"
          style="
            width: 100%;
            padding: 10px;
            background: #27ae60;
            border: none;
            border-radius: 4px;
            color: white;
            margin-bottom: 10px;
          "
        >
          Connect
        </button>
        <button
          id="disconnectBtn"
          style="width: 100%; padding: 10px; background: #e74c3c; border: none; border-radius: 4px; color: white"
          disabled
        >
          Disconnect
        </button>

        <div class="rooms-section">
          <h3>ðŸ“‹ Available Rooms</h3>
          <ul class="room-list" id="roomList"></ul>

          <div class="new-room">
            <input type="text" id="newRoomInput" placeholder="New room name..." />
            <button id="joinNewRoomBtn">Join</button>
          </div>
        </div>
      </div>

      <!-- Chat Area -->
      <div class="chat-area">
        <div class="chat-header">
          <h1 id="currentRoomName">Select a room</h1>
          <div class="room-info" id="roomInfo">Join or create a room to start chatting</div>
        </div>

        <div class="messages" id="messages">
          <div class="no-room-selected">ðŸ‘ˆ Select or create a room to start chatting</div>
        </div>

        <div class="input-area">
          <input type="text" id="messageInput" placeholder="Type your message..." disabled />
          <button id="sendBtn" disabled>Send</button>
        </div>
      </div>
    </div>

    <script>
      let ws = null;
      let currentRoom = null;
      let userId = null;
      let username = 'Guest';
      let availableRooms = new Map();
      let roomUsers = new Map(); // Map to store users in each room

      const status = document.getElementById('status');
      const connectBtn = document.getElementById('connectBtn');
      const disconnectBtn = document.getElementById('disconnectBtn');
      const usernameInput = document.getElementById('usernameInput');
      const setUsernameBtn = document.getElementById('setUsernameBtn');
      const roomList = document.getElementById('roomList');
      const newRoomInput = document.getElementById('newRoomInput');
      const joinNewRoomBtn = document.getElementById('joinNewRoomBtn');
      const currentRoomName = document.getElementById('currentRoomName');
      const roomInfo = document.getElementById('roomInfo');
      const messagesDiv = document.getElementById('messages');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');

      function updateStatus(isConnected) {
        if (isConnected) {
          status.textContent = 'Connected';
          status.className = 'status connected';
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
        } else {
          status.textContent = 'Disconnected';
          status.className = 'status disconnected';
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          messageInput.disabled = true;
          sendBtn.disabled = true;
        }
      }

      function addMessage(text, type = 'system', data = {}) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;

        if (type === 'system') {
          messageDiv.innerHTML = `<div class="text">${text}</div>`;
        } else {
          const isOwn = type === 'own';
          messageDiv.innerHTML = `
            ${!isOwn ? `<div class="username">${data.username || 'Unknown'}</div>` : ''}
            <div class="text">${text}</div>
            <div class="timestamp">${new Date(data.timestamp || Date.now()).toLocaleTimeString()}</div>
          `;
        }

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function clearMessages() {
        messagesDiv.innerHTML = '';
      }

      function updateRoomUI(room, users = []) {
        currentRoom = room;
        currentRoomName.textContent = `# ${room}`;
        roomInfo.textContent = `${users.length} user${users.length !== 1 ? 's' : ''} in this room`;
        messageInput.disabled = false;
        sendBtn.disabled = false;
        clearMessages();
        addMessage(`Joined room: ${room}`, 'system');

        // Store room users
        roomUsers.set(room, users);

        // Update room list to show active room
        updateRoomListDisplay();
      }

      function updateRoomList(rooms) {
        // Store rooms data
        availableRooms.clear();
        rooms.forEach((room) => {
          availableRooms.set(room.name, room.userCount || 0);
        });
        updateRoomListDisplay();
      }

      function updateRoomListDisplay() {
        roomList.innerHTML = '';
        availableRooms.forEach((userCount, roomName) => {
          const li = document.createElement('li');
          li.className = 'room-item' + (roomName === currentRoom ? ' active' : '');
          li.innerHTML = `
            <div class="room-name"># ${roomName}</div>
            <div class="user-count">${userCount} user${userCount !== 1 ? 's' : ''}</div>
          `;
          li.onclick = () => joinRoom(roomName);
          roomList.appendChild(li);
        });
      }

      function joinRoom(room) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          console.error('âŒ Cannot join room - not connected');
          alert('Please connect first');
          return;
        }

        console.log('ðŸ“¤ Joining room:', room);

        const joinMessage = {
          type: 'join_room',
          room: room,
        };

        ws.send(JSON.stringify(joinMessage));

        // Add room to available rooms if it's new
        if (!availableRooms.has(room)) {
          availableRooms.set(room, 1);
          updateRoomListDisplay();
        }
      }

      function sendMessage() {
        const message = messageInput.value.trim();

        if (!message) {
          console.warn('âš ï¸ No message to send');
          return;
        }

        if (!currentRoom) {
          console.error('âŒ Not in any room');
          alert('Please join a room first');
          return;
        }

        if (!ws || ws.readyState !== WebSocket.OPEN) {
          console.error('âŒ WebSocket not connected');
          alert('Not connected to server');
          return;
        }

        const chatMessage = {
          type: 'chat_message',
          room: currentRoom,
          message: message,
        };

        console.log('ðŸ“¤ Sending message:', chatMessage);
        ws.send(JSON.stringify(chatMessage));

        // Add our own message to the chat immediately
        addMessage(message, 'own', {
          username: username,
          timestamp: new Date().toISOString(),
        });

        messageInput.value = '';
      }

      function connect() {
        try {
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const host = window.location.host;
          const wsUrl = `${protocol}//${host}/ws`;

          console.log('Connecting to:', wsUrl);
          ws = new WebSocket(wsUrl);

          ws.onopen = function () {
            updateStatus(true);
            userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            console.log('âœ… WebSocket connected successfully');
            addMessage('Connected to server', 'system');

            // Send initial user info
            const userInfo = {
              type: 'user_connected',
              userId: userId,
              username: username,
            };
            ws.send(JSON.stringify(userInfo));
          };

          ws.onmessage = function (event) {
            console.log('ðŸ“¨ Raw message received:', event.data);
            try {
              const data = JSON.parse(event.data);
              console.log('âœ… Parsed message:', data);

              switch (data.type) {
                case 'connected':
                  userId = data.userId || userId;
                  username = data.username || username;
                  usernameInput.value = username;
                  addMessage(data.message || 'Successfully connected', 'system');
                  break;

                case 'username_updated':
                  username = data.username;
                  addMessage(`Username updated to: ${username}`, 'system');
                  break;

                case 'room_joined':
                  updateRoomUI(data.room, data.roomUsers || []);
                  if (data.message) {
                    addMessage(data.message, 'system');
                  }
                  break;

                case 'room_left':
                  addMessage(`Left room: ${data.room}`, 'system');
                  currentRoom = null;
                  currentRoomName.textContent = 'Select a room';
                  roomInfo.textContent = 'Join or create a room to start chatting';
                  messageInput.disabled = true;
                  sendBtn.disabled = true;
                  break;

                case 'user_joined':
                  if (data.room === currentRoom) {
                    addMessage(`${data.username} joined the room`, 'system');
                    // Update room user count
                    const currentUsers = roomUsers.get(currentRoom) || [];
                    if (!currentUsers.find((u) => u.userId === data.userId)) {
                      currentUsers.push({ userId: data.userId, username: data.username });
                      roomUsers.set(currentRoom, currentUsers);
                      roomInfo.textContent = `${currentUsers.length} user${currentUsers.length !== 1 ? 's' : ''} in this room`;
                    }
                  }
                  break;

                case 'user_left':
                  if (data.room === currentRoom) {
                    addMessage(`${data.username} left the room`, 'system');
                    // Update room user count
                    const currentUsers = roomUsers.get(currentRoom) || [];
                    const updatedUsers = currentUsers.filter((u) => u.userId !== data.userId);
                    roomUsers.set(currentRoom, updatedUsers);
                    roomInfo.textContent = `${updatedUsers.length} user${updatedUsers.length !== 1 ? 's' : ''} in this room`;
                  }
                  break;

                case 'chat_message':
                  if (data.room === currentRoom) {
                    const isOwn = data.userId === userId;
                    if (!isOwn) {
                      // Don't duplicate our own messages
                      addMessage(data.message, 'other', {
                        username: data.username,
                        timestamp: data.timestamp,
                      });
                    }
                  }
                  break;

                case 'rooms_list':
                  updateRoomList(data.rooms || []);
                  break;

                case 'room_users':
                  if (data.room === currentRoom) {
                    roomUsers.set(data.room, data.users || []);
                    roomInfo.textContent = `${data.users.length} user${data.users.length !== 1 ? 's' : ''} in this room`;
                  }
                  break;

                case 'error':
                  addMessage(`Error: ${data.message}`, 'system');
                  break;

                default:
                  console.log('Unknown message type:', data.type);
                  break;
              }
            } catch (parseError) {
              console.error('âŒ Error parsing message:', parseError);
              addMessage('Error parsing server message', 'system');
            }
          };

          ws.onclose = function (event) {
            updateStatus(false);
            addMessage(`Disconnected from server (Code: ${event.code})`, 'system');
            console.log('WebSocket disconnected:', event.code, event.reason);
          };

          ws.onerror = function (error) {
            console.error('âŒ WebSocket error:', error);
            addMessage('Connection error occurred', 'system');
          };
        } catch (error) {
          console.error('âŒ Failed to connect:', error);
          alert('Failed to connect: ' + error.message);
        }
      }

      function disconnect() {
        if (ws) {
          ws.close();
          ws = null;
        }
      }

      // Event listeners
      connectBtn.addEventListener('click', connect);
      disconnectBtn.addEventListener('click', disconnect);

      setUsernameBtn.addEventListener('click', () => {
        const newUsername = usernameInput.value.trim();
        if (newUsername) {
          username = newUsername;
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(
              JSON.stringify({
                type: 'set_username',
                username: newUsername,
              }),
            );
          }
          addMessage(`Username set to: ${newUsername}`, 'system');
        }
      });

      joinNewRoomBtn.addEventListener('click', () => {
        const roomName = newRoomInput.value.trim();
        if (roomName) {
          joinRoom(roomName);
          newRoomInput.value = '';
        }
      });

      sendBtn.addEventListener('click', sendMessage);

      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      newRoomInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          joinNewRoomBtn.click();
        }
      });

      usernameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          setUsernameBtn.click();
        }
      });

      // Initialize
      updateStatus(false);

      // Add some default rooms to start with
      availableRooms.set('general', 0);
      availableRooms.set('random', 0);
      availableRooms.set('tech-talk', 0);
      updateRoomListDisplay();

      // Set a default username
      username = 'Guest_' + Math.random().toString(36).substr(2, 6);
      usernameInput.value = username;
    </script>
  </body>
</html>
